# 订单服务设计

## 拉取订单信息

调用者传入

```
订单ID
```

订单服务根据ID返回

```
主订单信息
订单详细信息
```

## 设置订单状态

调用者传递

```
订单ID
订单状态
```

订单服务校验该订单的旧状态是否比新状态的值更小，如果是，同意更新，否则拒绝更新

## 设置支付状态

传递

```
订单ID
支付状态
```

校验一下
设置订单状态为新值

## 创建订单

传递

```
token
商品列表
    商品ID
    商品规格ID
    商品数量
订单备注
收货信息ID
```

校验参数

[根据token调用认证服务取得用户ID](./../基础设施服务群设计.md#鉴权)取得用户ID

[调用订餐者服务校验收货信息是否属于该用户](./订餐者服务设计.md#根据收货信息ID拉取)

根据

```
商品ID
商品规格ID
```

[调用商品服务获得商品信息与商品规格列表](./商品服务设计.md#根据商品ID与规格ID列表拉取商品信息)

使用获得商品规格以及上面的商品数量进行计算价格

对订单主表进行入库
对订单详情进行入库
生成商家取餐码，消费者取餐码，存入缓存

返回

```
订单ID
```

## 拉取订餐者订单列表

传递

```
token
页码
每页显示数
```

根据token获取用户ID

返回

```
店铺logo
订单名称（使用订单信息生成）
创建时间
总金额
订单状态
支付状态
```

列表

店铺logo需要[调用店铺服务批量拉取](./店铺服务设计.md#根据店铺ID列表批量拉取店铺)

## 订餐者拉取订单详细信息

传递

```
token
订单ID
```

返回

```
店铺logo
订单状态
支付状态
订单商品信息
订单总金额
订单号
订单创建时间
配送信息
  收货信息
  配送方式
  留言
```

店铺logo需要[调用店铺服务批量](./店铺服务设计.md#获取店铺信息)

收货信息需要[调用订餐者服务](./订餐者服务设计.md#根据收货信息ID拉取)

## 商家拉取订单列表

传递

```
token
页码
每页显示数
查询条件
    订单状态
    日期
```

根据token获取商家ID

返回

```
订单名称（使用订单信息生成）
创建时间
总金额
订单状态
支付状态
```

## 商家拉取订单详细信息

传递

```
token
订单ID
```

返回

```
订单状态
订单商品信息
订单总金额
订单号
订单创建时间
配送信息
  收货信息
  配送方式
  留言
```

店铺logo需要[调用店铺服务批量](./店铺服务设计.md#获取店铺信息)

收货信息需要[调用订餐者服务](./订餐者服务设计.md#根据收货信息ID拉取)

## 获取验证码

```
token
订单ID
```

校验token拥有者是否属于该订单

成功返回两个验证码

## 修改价格

传递

```
token
订单ID
新金额
```

根据token验证订单是否属于该商家

校验订单是否存在，且订单支付状态为待支付

成功后将订单金额设置为新金额

### 骑手可接单列表

传递

```
token
```

返回

商家已完成订单列表并且已支付